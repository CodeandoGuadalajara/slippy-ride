<!DOCTYPE html>
<html>
  <head>
    <title>Slippy Ride GDL</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
	<script type="text/javascript" src="/static/js/location-reporter.js"></script>
    <script type="text/javascript">
var map;
var routes = [];
function initialize() {
  var mapOptions = {
    zoom: 12,
    center: new google.maps.LatLng(20.65, -103.35)
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
	
	map.data.loadGeoJson('/static/geojson/routes.geojson');
		
		initializeSocket();
		
		var featureStyle = {
			strokeColor: 'blue',
			strokeWeight: 1,
			strokeOpacity: 0.5
		}
		map.data.setStyle(featureStyle);
		
		$("#startSimulation").click(function(){
			map.data.forEach(function(feature)
      		{
      			isSimulator = true;
      			processRoutes(feature);
      		});
		});
		
		$("#stopSimulation").click(function(){
			cleanupAndExit();
			location.reload();
		});
}

function startRoute(routeNumber, point, index){
	var direction = 1;
	
	// Make sure It's not the last point
	if (routes[routeNumber].geometry.getLength() - 1 == index){
		direction = -1;
	}
	
	// Create ID hash
	var current_date = (new Date()).valueOf().toString();
	var random = Math.random().toString();
	var hash = CryptoJS.SHA1("routeNumber" + index + current_date + random);
	var idHash = hash.toString(CryptoJS.enc.Hex);
	        
	// Emit bus location event
    var busLocationReporter = {"event": "new-bus-location", "data": { "id": idHash, "routeNumber": routeNumber, "lat": point.lat(), "lng": point.lng()}};
	socket.send(JSON.stringify(busLocationReporter));
	
	moveBus(idHash, point, index, direction, routeNumber, routes[routeNumber].geometry);

}

function moveBus(id, point, index, direction, routeNumber, routeGeometry){
	var frequency = ($("#frequency").val()) * 1000;
	
	setTimeout(function(){
		var nextIndex = index + direction;
		var newPosition = routeGeometry.getAt(nextIndex);
		
		if (newPosition == null){
			console.log(id, nextIndex, routeGeometry);
		}
		// Move point
		// Emit bus location event
    	var busLocationReporter = {"event": "updated-bus-location", "data": {"id": id, "routeNumber": routeNumber, "lat": newPosition.lat(), "lng": newPosition.lng()}};
		socket.send(JSON.stringify(busLocationReporter));

		// If we are on the first point go forward, if we are on the last, go backwards
		if (nextIndex == 1){
			direction = 1;
		} else if (nextIndex == routeGeometry.getLength() - 1){
			direction = -1;
		}	
      moveBus(id, newPosition, nextIndex, direction, routeNumber, routeGeometry);
	},frequency);
}

function processRoutes(route) {
	var routeNumber = route.getProperty("RUTA");
	var routeGeometry = route.getGeometry();
	var routeUnits = $("#unitsPerRoute").val();
	var routePointsNumber = routeGeometry.getLength();
	
	if (routeUnits == 0){
		routeUnits = route.getProperty("FLOTA");
	}
	
	// Add to routes array
	var route = {number: routeNumber, geometry: routeGeometry};
	
	routes[routeNumber]=route;
		
	for (var i = 0; i < routeUnits; i++){
		// Get a random point on the route
		var randomPointNumber = Math.floor((Math.random() * (routePointsNumber - 1)) + 1);
		startRoute(routeNumber, routeGeometry.getAt(randomPointNumber), randomPointNumber);
	}
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="controls">
       No. de unidades por ruta: <input type="text" id="unitsPerRoute" style="width:30px;">
        Frecuencia (en segundos): <input type="text" id="frequency" style="width:30px;">
       <input type="button" id="startSimulation" value="Iniciar simulación">
       <input type="button" id="stopSimulation" value="Detener simulación">
    </div>
    <div id="map-canvas"></div>
  </body>
</html>
